name: "Run Coverage And Generate Badge"
on:
  push:
    branches: [
      "main",
      # todo: just for test, remove later
      "test/*",
      "!test/*-alpha",
    ]
    paths:
      - "src/**"
      - ".github/workflows/coverage.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "src/**"
      - ".github/workflows/coverage.yml"
    types:
      - "opened"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  coverage-run-and-genbadge:
    name: "coverage run, coverage xml and genbadge"
    runs-on: [
      "ubuntu-latest"
    ]
    steps:
      - name: "checkout"
        uses: "actions/checkout@v5.0.0"
      - name: "install uv"
        env:
          ENV LANG: C.UTF-8
          UV_INSTALLER_GHE_BASE_URL: "https://files.m.daocloud.io/github.com"
          UV_PYTHON_INSTALL_MIRROR: "https://files.m.daocloud.io/github.com/astral-sh/python-build-standalone/releases/download"
          UV_COMPILE_BYTECODE: 1
          UV_LINK_MODE: copy
          PATH: "/root/.local/bin:$PATH"
        run: |
          apt update
          apt-get install -y curl
          apt-get clean -y && rm -rf /var/lib/apt/lists/*

          curl -LsSf -o uv_install.sh https://files.m.daocloud.io/astral.sh/uv/install.sh
          sh uv_install.sh
          rm uv_install.sh
          uv --version
      - name: "uv sync"
        run: |
          echo "uv sync"
